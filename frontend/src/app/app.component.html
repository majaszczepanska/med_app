@if (!isLoggedIn) {
  <router-outlet></router-outlet>
}
@else {
  <div class="max-w-[1400px] mx-auto p-5 font-sans">
   @if (userRole === 'ADMIN') {
      <h1 class="text-center text-gray-800 text-3xl font-bold mb-8">Medical Management System (Admin Panel) üëë</h1>
    } @else if (userRole === 'DOCTOR') {
      <h1 class="text-center text-gray-800 text-3xl font-bold mb-8">Doctor Dashboard üë®‚Äç‚öïÔ∏è</h1>
    } @else if (userRole === 'PATIENT') {
      <h1 class="text-center text-gray-800 text-3xl font-bold mb-8">Patient Portal ü©∫</h1>
    }

    <div class="flex flex-col lg:flex-row gap-8 items-start">

      <div class="w-full lg:w-[320px] shrink-0 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-sm lg:sticky lg:top-5 h-fit">

        @if (activeTab === 'dashboard' || activeTab === 'profile' || activeTab === 'history') {
          <div class="text-center py-10 px-2">
            <img src="https://cdn-icons-png.flaticon.com/512/3063/3063206.png" class="w-[130px] opacity-90 mx-auto mb-5 hidden lg:block" alt="Medical Clinic">
            
            <h3 class="text-gray-800 text-xl font-bold mb-2">MedApp Clinic</h3>
            <p class="text-gray-500 text-sm leading-relaxed">
              Advanced Healthcare<br>Right At Your Fingertips.
            </p>
            
            <div class="mt-10 p-4 bg-gray-100 rounded-lg border border-gray-200">
              <p class="m-0 text-xs text-gray-600">üìû Reception & Helpdesk:</p>
              <p class="mt-1 font-bold text-lg text-cyan-600">+48 123 456 789</p>
              <p class="mt-1 text-xs text-gray-500">Mon - Fri: 8:00 - 16:00</p>
            </div>
          </div>
        }
        
        @if (activeTab === 'patients') {
          <h3 class="text-gray-700 text-xl font-bold border-b-4 border-green-500 pb-2 mb-5 inline-block">@if(isEditing){Edit} @else{Add} Patient</h3>
          <form (input)="clearDashboardMessages()" (change)="clearDashboardMessages()" #patientForm="ngForm">

            <label class="block font-semibold text-gray-700 mb-2 text-sm">First Name <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newPatient.firstName" name="patientFirstName" 
                  minlength="3" 
                  pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
                  #patientFirstNameCtrl="ngModel" placeholder="First name"
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
            @if (patientFirstNameCtrl.invalid && (patientFirstNameCtrl.dirty || patientFirstNameCtrl.touched)  && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">
                @if (patientFirstNameCtrl.errors?.['required']) { <span class="block">‚ùå First name is required.</span> }
                @if (patientFirstNameCtrl.errors?.['minlength']) { <span class="block">‚ùå Min. 3 characters.</span> }
                @if (patientFirstNameCtrl.errors?.['pattern']) { <span class="block">‚ùå Must start with a capital letter & contain letters only.</span> }
              </div>
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Last Name <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newPatient.lastName" name="patientLastName"
                  minlength="3" 
                  pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
                  #patientLastNameCtrl="ngModel" placeholder="Last name"
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
            @if (patientLastNameCtrl.invalid && (patientLastNameCtrl.dirty || patientLastNameCtrl.touched) && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">
                @if (patientLastNameCtrl.errors?.['required']) { <span class="block">‚ùå Last name is required.</span> }
                @if (patientLastNameCtrl.errors?.['minlength']) { <span class="block">‚ùå Min. 3 characters.</span> }
                @if (patientLastNameCtrl.errors?.['pattern']) { <span class="block">‚ùå Must start with a capital letter & contain letters only.</span> }
              </div>
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">PESEL <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newPatient.pesel" name="pesel"  
                  pattern="^\d{2}(?:0[1-9]|1[0-2]|2[1-9]|3[0-2]|4[1-9]|5[0-2]|6[1-9]|7[0-2]|8[1-9]|9[0-2])(?:0[1-9]|[12]\d|3[01])\d{5}$" 
                  #peselCtrl="ngModel" placeholder="PESEL"
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
            @if (peselCtrl.invalid && (peselCtrl.dirty || peselCtrl.touched) && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">
                @if (peselCtrl.errors?.['required']) { <span class="block">‚ùå PESEL is required.</span> }
                @if (peselCtrl.errors?.['pattern']) { <span class="block">‚ùå Invalid PESEL format (check your data).</span> }
              </div>
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Chronic Diseases / Allergies:</label>
            <input type="text" [(ngModel)]="newPatient.disease" name="disease" placeholder="Disease" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition">

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Main doctor (ID):</label>
            <select [(ngModel)]="newPatient.mainDoctor" name="mainDoctor" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition bg-white">
              <option [ngValue]="''">-- No Primary Doctor --</option>
              @for (d of doctors; track d.id) {
                <option [ngValue]="d.id">Dr. {{ d.lastName }} ({{ d.specialization }})</option>
              }
            </select>

            @if(!isEditing) {
              <div class="bg-blue-50 p-4 rounded-lg mb-5 border-l-4 border-blue-500">
                <p class="mt-0 font-bold text-sm text-gray-700 mb-3">Patient's Account Data:</p>
                
                <label class="block font-semibold text-gray-700 mb-2 text-xs">Email (Login) <span class="text-red-500">*</span></label>
                <input type="email" [(ngModel)]="newPatient.email" name="patientEmail" placeholder="patient@example.com" class="w-full p-3 mb-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" #patientEmailCtrl="ngModel" required email>
                @if (patientEmailCtrl.invalid && (patientEmailCtrl.dirty || patientEmailCtrl.touched) && !dashboardSuccess) {
                  <div class="text-red-600 text-sm -mt-1 mb-3 font-medium">‚ùå Required valid email.</div>
                }

                <label class="block font-semibold text-gray-700 mb-2 text-xs">Password <span class="text-red-500">*</span></label>
                <input type="password" name="patientPass" #patientPassCtrl="ngModel" [(ngModel)]="newPatient.password" minlength="6" placeholder="Temporary password" class="w-full p-3 mb-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                @if (patientPassCtrl.invalid && (patientPassCtrl.dirty || patientPassCtrl.touched)) {
                  <div class="text-red-600 text-sm mt-1 font-medium">‚ùå Password is required (min 6 characters).</div>
                }
              </div>
            }
          
            @if (dashboardSuccess) {
              <div class="bg-green-100 text-green-800 p-3 rounded-md mb-4 border border-green-200 font-medium">{{ dashboardSuccess }}</div>
            }
            @if (dashboardError) {
              <div class="bg-red-100 text-red-800 p-3 rounded-md mb-4 border border-red-200 font-medium">{{ dashboardError }}</div>
            }

            @if (isEditing) {
              <div class="flex gap-2">
                <button (click)="onSubmit()" type="submit" [disabled]="patientForm.invalid" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">UPDATE</button>
                <button (click)="cancelEdit()" type="button" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg uppercase transition-colors">CANCEL</button>
              </div>
            } @else {
              <button (click)="onSubmit()" type="submit" [disabled]="patientForm.invalid" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">SAVE PATIENT</button>
            }
          </form>
        }


        @if (activeTab === 'doctors') {
          <h3 class="text-gray-700 text-xl font-bold border-b-4 border-blue-500 pb-2 mb-5 inline-block">@if(isEditing){Edit} @else{Add} Doctor</h3>
          <form (input)="clearDashboardMessages()" (change)="clearDashboardMessages()" #docForm="ngForm">
            <label class="block font-semibold text-gray-700 mb-2 text-sm">First Name <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newDoctor.firstName" name="docFirstName"
                  minlength="3" pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
                  #docFirstNameCtrl="ngModel" placeholder="First name"
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
            @if (docFirstNameCtrl.invalid && (docFirstNameCtrl.dirty || docFirstNameCtrl.touched)  && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">
                @if (docFirstNameCtrl.errors?.['required']) { <span class="block">‚ùå First name is required.</span> }
                @if (docFirstNameCtrl.errors?.['minlength']) { <span class="block">‚ùå Min. 3 characters.</span> }
                @if (docFirstNameCtrl.errors?.['pattern']) { <span class="block">‚ùå Must start with a capital letter.</span> }
              </div>
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Last Name <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newDoctor.lastName" name="docLastName"
                  minlength="3" pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
                  #docLastNameCtrl="ngModel" placeholder="Last name"
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
            @if (docLastNameCtrl.invalid && (docLastNameCtrl.dirty || docLastNameCtrl.touched) && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">
                @if (docLastNameCtrl.errors?.['required']) { <span class="block">‚ùå Last name is required.</span> }
                @if (docLastNameCtrl.errors?.['minlength']) { <span class="block">‚ùå Min. 3 characters.</span> }
                @if (docLastNameCtrl.errors?.['pattern']) { <span class="block">‚ùå Must start with a capital letter.</span> }
              </div>
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Specialization <span class="text-red-500">*</span></label>
            <input type="text" [(ngModel)]="newDoctor.specialization" name="docSpecialization" 
                  minlength="3" #docSpecCtrl="ngModel" placeholder="e.g. Cardiologist" 
                  class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
            @if (docSpecCtrl.invalid && (docSpecCtrl.dirty || docSpecCtrl.touched) && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Specialization is required (min 3 chars).</div>
            }

            @if(!isEditing) {
              <div class="bg-blue-50 p-4 rounded-lg mb-5 border-l-4 border-blue-500">
                <p class="mt-0 font-bold text-sm text-gray-700 mb-3">Doctor's Account Data:</p>
                
                <label class="block font-semibold text-gray-700 mb-2 text-xs">Email (Login) <span class="text-red-500">*</span></label>
                <input type="email" [(ngModel)]="newDoctor.email" name="docEmail" #docEmailCtrl="ngModel" placeholder="doctor@med.com" class="w-full p-3 mb-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required email>
                @if (docEmailCtrl.invalid && (docEmailCtrl.dirty || docEmailCtrl.touched) && !dashboardSuccess) {
                  <div class="text-red-600 text-sm -mt-1 mb-3 font-medium">‚ùå Required valid email.</div>
                }

                <label class="block font-semibold text-gray-700 mb-2 text-xs">Password <span class="text-red-500">*</span></label>
                <input type="password" [(ngModel)]="newDoctor.password" name="docPass" #docPassCtrl="ngModel" minlength="6" placeholder="Temporary password" class="w-full p-3 mb-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                @if (docPassCtrl.invalid && (docPassCtrl.dirty || docPassCtrl.touched) && !dashboardSuccess) {
                  <div class="text-red-600 text-sm mt-1 font-medium">‚ùå Password is required (min 6 characters).</div>
                }
              </div>
            }

            @if (dashboardSuccess) {
              <div class="bg-green-100 text-green-800 p-3 rounded-md mb-4 border border-green-200 font-medium">{{ dashboardSuccess }}</div>
            }
            @if (dashboardError) {
              <div class="bg-red-100 text-red-800 p-3 rounded-md mb-4 border border-red-200 font-medium">{{ dashboardError }}</div>
            }

            @if(isEditing) {
              <div class="flex gap-2">
                <button (click)="onSubmit()" type="submit" [disabled]="docForm.invalid" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">UPDATE</button>
                <button (click)="cancelEdit()" type="button" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg uppercase transition-colors">CANCEL</button>
              </div>
            } @else {
              <button (click)="onSubmit()" type="submit" [disabled]="docForm.invalid" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">SAVE DOCTOR</button>
            }
          </form>
        }

        @if (activeTab === 'appointments') {
          <h3 class="text-gray-700 text-xl font-bold border-b-4 border-purple-600 pb-2 mb-5 inline-block">@if(isEditing){Edit} @else{Book} Appointment</h3>
          <form (input)="clearDashboardMessages()" (change)="clearDashboardMessages()" #apptForm="ngForm">
            
            <label class="block font-semibold text-gray-700 mb-2 text-sm">Date & Time <span class="text-red-500">*</span></label>
            <input type="datetime-local" [(ngModel)]="newAppointment.visitTime" name="visitTime" #visitTimeCtrl="ngModel" [min]="minDate" (click)="updateMinDate()" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition" required>
            @if (visitTimeCtrl.invalid && (visitTimeCtrl.dirty || visitTimeCtrl.touched) && !dashboardSuccess) {
              <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Date and Time are required.</div>
            }

            @if (userRole === 'ADMIN') {
              <label class="block font-semibold text-gray-700 mb-2 text-sm">Choose Patient <span class="text-red-500">*</span></label>
              <select [(ngModel)]="newAppointment.patientId" name="adminPatientId" #adminPatCtrl="ngModel" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition bg-white" required>
                <option [ngValue]="null">-- Select Patient --</option>
                @for (p of patients; track p.id) {
                  <option [ngValue]="p.id">{{ p.lastName }} {{ p.firstName }} (PESEL: {{ p.pesel }})</option>
                }
              </select>
              @if (adminPatCtrl.invalid && (adminPatCtrl.dirty || adminPatCtrl.touched) && !dashboardSuccess) {
                <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Patient is required.</div>
              }

              <label class="block font-semibold text-gray-700 mb-2 text-sm">Choose Doctor <span class="text-red-500">*</span></label>
              <select [(ngModel)]="newAppointment.doctorId" name="adminDoctorId" #adminDocCtrl="ngModel" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition bg-white" required>
                <option [ngValue]="null">-- Select Doctor --</option>
                @for (d of doctors; track d.id) {
                  <option [ngValue]="d.id">Dr. {{ d.lastName }} ({{ d.specialization }})</option>
                }
              </select>
              @if (adminDocCtrl.invalid && (adminDocCtrl.dirty || adminDocCtrl.touched) && !dashboardSuccess) {
                <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Doctor is required.</div>
              }
            }

            @if (userRole === 'DOCTOR') {
              <label class="block font-semibold text-gray-700 mb-2 text-sm">Choose Patient <span class="text-red-500">*</span></label>
              <select [(ngModel)]="newAppointment.patientId" name="docPatientId" #docPatCtrl="ngModel" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition bg-white" required>
                <option [ngValue]="null">-- Select Patient --</option>
                @for (p of patients; track p.id) {
                  <option [ngValue]="p.id">{{ p.lastName }} {{ p.firstName }} (PESEL: {{ p.pesel }})</option>
                }
              </select>
              @if (docPatCtrl.invalid && (docPatCtrl.dirty || docPatCtrl.touched) && !dashboardSuccess) {
                <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Patient is required.</div>
              }
            }

            @if (userRole === 'PATIENT') {
              <label class="block font-semibold text-gray-700 mb-2 text-sm">Choose Doctor <span class="text-red-500">*</span></label>
              <select [(ngModel)]="newAppointment.doctorId" name="patDoctorId" #patDocCtrl="ngModel" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition bg-white" required>
                <option [ngValue]="null">-- Select Doctor --</option>
                @for (d of doctors; track d.id) {
                  <option [ngValue]="d.id">Dr. {{ d.lastName }} ({{ d.specialization }})</option>
                }
              </select>
              @if (patDocCtrl.invalid && (patDocCtrl.dirty || patDocCtrl.touched) && !dashboardSuccess) {
                <div class="text-red-600 text-sm -mt-3 mb-4 font-medium">‚ùå Doctor is required.</div>
              }
            }

            <label class="block font-semibold text-gray-700 mb-2 text-sm">Diagnosis / Notes:</label>
            <textarea [(ngModel)]="newAppointment.description" name="description"
                      placeholder="Enter diagnosis, symptoms, or medications..."
                      rows="3"
                      maxlength="500"
                      class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-600 transition resize-y min-h-[100px] max-h-[300px]">
            </textarea>

            @if (dashboardSuccess) {
              <div class="bg-green-100 text-green-800 p-3 rounded-md mb-4 border border-green-200 font-medium">{{ dashboardSuccess }}</div>
            }
            @if (dashboardError) {
              <div class="bg-red-100 text-red-800 p-3 rounded-md mb-4 border border-red-200 font-medium">{{ dashboardError }}</div>
            }

            @if (isEditing) {
              <div class="flex gap-2">
                <button (click)="onSubmit()" type="submit" [disabled]="apptForm.invalid" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">UPDATE</button>
                <button (click)="cancelEdit()" type="button" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg uppercase transition-colors">CANCEL</button>
              </div>
            } @else {
              <button (click)="onSubmit()" type="submit" [disabled]="apptForm.invalid" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg uppercase transition-colors disabled:opacity-50 disabled:cursor-not-allowed">BOOK VISIT</button>
            }
          </form>
        }

      </div>

      <div class="flex-1 bg-white p-5 rounded-xl shadow-sm border border-gray-200 w-full overflow-hidden relative">

        <div class="lg:hidden flex justify-between items-center pb-3 mb-5 border-b-2 border-gray-200">
          <h3 class="m-0 text-purple-700 text-xl font-bold">MedApp Menu</h3>
          <button class="bg-gray-100 border border-gray-300 rounded-md text-2xl text-gray-700 px-3 py-1 cursor-pointer active:bg-gray-200 transition" (click)="toggleMenu()">‚ò∞</button>
        </div>

        <div class="hidden lg:flex mb-6 border-b-2 border-gray-200 gap-2 overflow-x-auto" 
             [class.!flex]="isMobileMenuOpen" [class.flex-col]="isMobileMenuOpen" [class.absolute]="isMobileMenuOpen" 
             [class.top-[70px]]="isMobileMenuOpen" [class.right-4]="isMobileMenuOpen" [class.bg-white]="isMobileMenuOpen" 
             [class.shadow-xl]="isMobileMenuOpen" [class.p-2]="isMobileMenuOpen" [class.rounded-xl]="isMobileMenuOpen" 
             [class.z-50]="isMobileMenuOpen" [class.w-[260px]]="isMobileMenuOpen" [class.border]="isMobileMenuOpen" [class.border-gray-200]="isMobileMenuOpen">
          
          <button [class.text-gray-900]="activeTab === 'dashboard'" [class.border-green-500]="activeTab === 'dashboard'" [class.bg-green-50]="activeTab === 'dashboard' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('dashboard')">üìä Dashboard</button>
          
          @if (userRole === 'ADMIN' || userRole === 'DOCTOR'){
            <button [class.text-gray-900]="activeTab === 'patients'" [class.border-green-500]="activeTab === 'patients'" [class.bg-green-50]="activeTab === 'patients' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('patients')">Patients</button>
          }
          @if (userRole === 'ADMIN'){
            <button [class.text-gray-900]="activeTab === 'doctors'" [class.border-green-500]="activeTab === 'doctors'" [class.bg-green-50]="activeTab === 'doctors' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('doctors')">Doctors</button>
          }
          <button [class.text-gray-900]="activeTab === 'appointments'" [class.border-green-500]="activeTab === 'appointments'" [class.bg-green-50]="activeTab === 'appointments' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('appointments')">Appointments</button>
          
          @if (userRole === 'PATIENT') {
            <button [class.text-gray-900]="activeTab === 'history'" [class.border-green-500]="activeTab === 'history'" [class.bg-green-50]="activeTab === 'history' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('history')">üìú My History</button>
          }
          <button [class.text-gray-900]="activeTab === 'profile'" [class.border-green-500]="activeTab === 'profile'" [class.bg-green-50]="activeTab === 'profile' && isMobileMenuOpen" class="whitespace-nowrap bg-transparent px-5 py-3 text-base font-semibold text-gray-500 border-b-4 border-transparent transition-all hover:text-blue-700 hover:bg-gray-50 lg:rounded-t-md text-left" (click)="setActiveTab('profile')">My Profile ‚öôÔ∏è</button>
          
          <button class="whitespace-nowrap bg-transparent font-semibold text-red-500 hover:bg-red-50 py-3 px-5 lg:ml-auto transition-colors lg:rounded-lg text-left" [class.mt-2]="isMobileMenuOpen" [class.border-t]="isMobileMenuOpen" [class.border-gray-100]="isMobileMenuOpen" (click)="logout()">üö™ Logout</button>
        </div>


        @if (activeTab === 'dashboard') {
          <div>
            @if (userRole === 'ADMIN' || userRole === 'DOCTOR') {
              <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
                <div class="p-6 rounded-xl text-white text-center shadow-md hover:-translate-y-1 transition-transform bg-gradient-to-br from-blue-500 to-blue-700">
                  <div class="text-[3.5em] font-bold mb-2 leading-none">{{ patients.length }}</div>
                  <div class="text-[1.1em] opacity-90 uppercase tracking-[1px] font-medium">Patients Registered</div>
                </div>
              
                <div class="p-6 rounded-xl text-white text-center shadow-md hover:-translate-y-1 transition-transform bg-gradient-to-br from-green-500 to-green-700">
                  <div class="text-[3.5em] font-bold mb-2 leading-none">{{ doctors.length }}</div>
                  <div class="text-[1.1em] opacity-90 uppercase tracking-[1px] font-medium">Active Doctors</div>
                </div>
              
                <div class="p-6 rounded-xl text-white text-center shadow-md hover:-translate-y-1 transition-transform bg-gradient-to-br from-purple-600 to-purple-800">
                  <div class="text-[3.5em] font-bold mb-2 leading-none">{{ appointments.length }}</div>
                  <div class="text-[1.1em] opacity-90 uppercase tracking-[1px] font-medium">Total Appointments</div>
                </div>
              </div>
            }

            @if (userRole === 'PATIENT') {
              <div class="bg-gray-100 p-5 rounded-lg mb-5 border-l-4 border-cyan-500">
                <h2 class="mt-0 text-gray-800 text-2xl font-bold mb-2">Welcome to your Patient Portal ü©∫</h2>
                <p class="text-gray-600 m-0">Here you can book new appointments, view your medical history, and update your details.</p>
              </div>
            }
          
            <h3 class="mt-8 border-b-2 border-gray-200 pb-2 text-lg font-bold text-gray-700">
              üìÖ Upcoming Appointments (Next 5)
            </h3>
          
            @if (upcomingAppointments.length === 0) {
              <p class="text-center text-gray-500 text-lg p-10 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 mt-4">No upcoming appointments scheduled.</p>
            } @else {
              <div class="overflow-x-auto mt-4 pb-2">
                <table class="w-full text-left bg-white border border-gray-200 rounded-lg overflow-hidden whitespace-nowrap">
                  <thead class="bg-gray-600 text-white">
                    <tr>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Time</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Patient</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Doctor</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide text-center">Status</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    @for (a of upcomingAppointments; track a.id) {
                      <tr class="hover:bg-gray-50 transition-colors h-[45px]">
                        <td class="px-3 py-2 font-bold text-gray-800 align-middle">{{ formatDateDisplay(a.visitTime) }}</td>
                        <td class="px-3 py-2 text-gray-700 align-middle">{{ a.patient?.lastName }} {{ a.patient?.firstName }}</td>
                        <td class="px-3 py-2 text-gray-700 align-middle">Dr. {{ a.doctor?.lastName }}</td>
                        <td class="px-3 py-2 text-center align-middle">
                          <span class="bg-green-100 text-green-800 px-2 py-1 rounded-[10px] text-xs font-bold inline-block">SCHEDULED</span>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }       
          </div>
        }
        
        @if (activeTab === 'patients') {
          <h3 class="text-[1.5em] text-gray-700 font-bold mb-6">Patient Registry</h3>
          <div class="mb-4">
            <input type="text" [(ngModel)]="searchText" placeholder="üîç Search Last name or PESEL..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
          </div>
          
          <div class="overflow-x-auto pb-2">
            <table class="w-full text-left bg-white border border-gray-200 rounded-lg overflow-hidden whitespace-nowrap">
              <thead class="bg-purple-700 text-white">
                <tr>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Full Name</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Pesel</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Chronic Disease</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Main Doctor</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide text-center">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                @for (p of filteredPatients; track p.id){
                  <tr class="hover:bg-gray-50 transition-colors h-[45px]">
                    <td class="px-3 py-2 font-semibold text-gray-800 align-middle">{{ p.firstName }} {{ p.lastName }}</td>
                    <td class="px-3 py-2 text-gray-600 align-middle">{{ p.pesel }}</td>
                    <td class="px-3 py-2 text-gray-600 align-middle">{{ p.disease }}</td>
                    <td class="px-3 py-2 text-gray-600 align-middle">{{ p.mainDoctor?.lastName || '-' }}</td> 
                    <td class="px-3 py-2 text-center align-middle">
                      <div class="flex items-center justify-center gap-2">
                        <button (click)="showPatientHistory(p)" class="bg-cyan-500 hover:bg-cyan-600 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">üìú History</button>
                        <button (click)="editPatient(p)" class="bg-blue-600 hover:bg-blue-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">Edit</button>
                        <button (click)="removePatient(p.id)" class="bg-red-600 hover:bg-red-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">Delete</button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        @if (activeTab === 'doctors') {
          <h3 class="text-[1.5em] text-blue-600 font-bold mb-6">Doctors List</h3>
          <div class="mb-4">
            <input type="text" [(ngModel)]="searchText" placeholder="üîç Search Last name or specialization" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="overflow-x-auto pb-2">
            <table class="w-full text-left bg-white border border-gray-200 rounded-lg overflow-hidden whitespace-nowrap">
              <thead class="bg-blue-600 text-white">
                <tr>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Full Name</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Specialization</th>
                  <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide text-center">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                @for (d of filteredDoctors; track d.id){
                  <tr class="hover:bg-gray-50 transition-colors h-[45px]">
                    <td class="px-3 py-2 font-semibold text-gray-800 align-middle">Dr. {{ d.firstName }} {{ d.lastName }}</td>
                    <td class="px-3 py-2 text-gray-600 align-middle">{{ d.specialization }}</td>
                    <td class="px-3 py-2 text-center align-middle">
                      <div class="flex items-center justify-center gap-2">
                        <button (click)="editDoctor(d)" class="bg-blue-600 hover:bg-blue-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">Edit</button>
                        <button (click)="removeDoctor(d.id)" class="bg-red-600 hover:bg-red-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">Delete</button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        @if (activeTab === 'appointments') {
          
          <h3 class="text-[1.5em] text-purple-600 font-bold mb-6">Appointments Schedule</h3>
          
          <div class="flex flex-col md:flex-row justify-between md:items-center mb-5 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div class="flex gap-1 bg-gray-200 p-1 rounded-md">
              <button (click)="showCalendar = false" [class.bg-white]="!showCalendar" [class.text-purple-700]="!showCalendar" [class.shadow-sm]="!showCalendar" class="px-4 py-2 bg-transparent rounded font-semibold text-gray-600 transition-all border-none cursor-pointer">List View</button>
              <button (click)="showCalendar = true" [class.bg-white]="showCalendar" [class.text-purple-700]="showCalendar" [class.shadow-sm]="showCalendar" class="px-4 py-2 bg-transparent rounded font-semibold text-gray-600 transition-all border-none cursor-pointer">Calendar View</button>
            </div>

            @if (userRole === 'ADMIN' || userRole === 'PATIENT') {
              <div class="flex items-center gap-2 w-full md:w-auto">
                <label class="font-semibold text-gray-700 whitespace-nowrap text-sm">Filter by Doctor:</label>
                <select [(ngModel)]="selectedDoctorId" (change)="onDoctorFilterChange()" class="p-2.5 border border-gray-300 rounded-md w-full md:min-w-[250px] bg-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option [ngValue]="null">-- ALL DOCTORS --</option>
                  @for (d of doctors; track d.id) {
                    <option [ngValue]="d.id">Dr. {{ d.lastName }} ({{ d.specialization }})</option>
                  }
                </select>
              </div>
            }
          </div>

          @if (showCalendar) {
            <div class="w-full overflow-x-auto">
              <full-calendar [options]="calendarOptions"></full-calendar>
            </div>
          }

          @if (!showCalendar) {
            <div class="mb-4">
              <input type="text" [(ngModel)]="searchText" placeholder="üîç Search patient or doctor Last name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>

            @if (userRole === 'PATIENT' && !(filteredAppointments.length === 0)) {
              <div class="bg-blue-50 text-cyan-800 p-3 rounded-md mb-4 border-l-4 border-cyan-500 text-sm">
                ‚ÑπÔ∏è <strong>Upcoming Appointments:</strong> This list shows only your future visits. 
                For past visits and diagnosis, please check the <strong>"My History"</strong> tab.
              </div>
            }

            @if (userRole === 'DOCTOR' || userRole === 'ADMIN') {
              <div class="bg-yellow-50 text-yellow-800 p-3 rounded-md mb-4 border-l-4 border-yellow-500 text-sm">
                üìÖ <strong>Active Schedule:</strong> Displaying all appointments for <strong>Today</strong> (including completed) and <strong>Future</strong> dates.
              </div>
            }

            @if (filteredAppointments.length === 0) {
              <div class="text-center p-10 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 mt-5">
                <p class="m-0 text-lg text-gray-500">
                  üì≠ No appointments to display right now.
                </p>
              </div>
            } @else {
              <div class="overflow-x-auto pb-2">
                <table class="w-full text-left bg-white border border-gray-200 rounded-lg overflow-hidden whitespace-nowrap">
                  <thead class="bg-purple-700 text-white">
                    <tr>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Date & Time</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Patient</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Doctor</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Notes</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Status</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    @for (a of filteredAppointments; track a.id) {
                      <tr [class.opacity-50]="isPastDate(a.visitTime)" [class.bg-green-50]="isOngoing(a.visitTime)" class="hover:bg-gray-50 transition-colors h-[45px]">                     

                        <td class="px-3 py-2 font-bold text-gray-800 align-middle">{{ formatDateDisplay(a.visitTime) }}</td>
                        <td class="px-3 py-2 text-gray-700 align-middle">{{ a.patient?.firstName }} {{ a.patient?.lastName}}</td>
                        <td class="px-3 py-2 text-gray-700 align-middle">Dr. {{ a.doctor?.lastName }}</td>
                        <td class="px-3 py-2 text-gray-600 align-middle max-w-[250px] overflow-hidden text-ellipsis" [title]="a.description">{{ a.description || '-'}}</td>

                        <td class="px-3 py-2 align-middle">
                          @if (a.status === 'COMPLETED') {
                            <span class="bg-green-800 text-white px-2 py-1 rounded-md text-[0.9em] font-semibold inline-block">‚úÖ COMPLETED</span>
                          } 
                          @else if (isOngoing(a.visitTime)) {
                            <span class="bg-green-500 text-white shadow-[0_0_8px_#28a745] px-2 py-1 rounded-md text-[0.9em] font-semibold inline-block">üîÑ IN PROGRESS</span>
                          } 
                          @else if (a.status === 'SCHEDULED') {
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md text-[0.9em] font-semibold inline-block">‚è≥ SCHEDULED</span>
                          }
                        </td>

                        <td class="px-3 py-2 text-center align-middle">
                          <div class="flex items-center justify-center gap-2">
                            @if (userRole === 'DOCTOR' && a.status === 'SCHEDULED' && !isFutureDate(a.visitTime)) {
                              <button (click)="completeAppointment(a)" class="bg-green-500 hover:bg-green-600 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">COMPLETE</button>
                            }

                            @if (a.status === 'SCHEDULED' || (userRole === 'DOCTOR' && a.status === 'COMPLETED')) {
                              <button (click)="editAppointment(a)" class="bg-blue-600 hover:bg-blue-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">EDIT</button>
                            }

                            @if (a.status === 'SCHEDULED' && !isOngoing(a.visitTime)) {
                              <button (click)="removeAppointment(a.id)" class="bg-red-600 hover:bg-red-700 text-white px-2.5 py-1 rounded-md text-[1em] font-semibold transition-transform active:translate-y-px shadow-sm">CANCEL</button>
                            }
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }
          
        }

        @if (activeTab === 'history' && selectedPatientForHistory) {
          <div>
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-5 gap-3">
              <h3 class="text-xl font-bold text-gray-800 m-0">
                Medical History: 
                <span class="text-blue-600">
                  {{ selectedPatientForHistory.firstName }} {{ selectedPatientForHistory.lastName }}
                </span>
              </h3>
              @if (userRole === 'PATIENT') {
                <button (click)="closeHistory()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md uppercase text-sm transition-colors">‚¨Ö BACK TO DASHBOARD</button>
              } @else {
                <button (click)="closeHistory()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md uppercase text-sm transition-colors">‚¨Ö BACK TO LIST</button>
              }     
            </div>
          
            <div class="bg-gray-50 p-4 rounded-lg mb-5 border-l-4 border-blue-600 text-gray-700 text-sm">
              <p class="mb-1"><strong>PESEL:</strong> {{ selectedPatientForHistory.pesel }}</p>
              <p class="mb-1"><strong>Chronic Disease:</strong> {{ selectedPatientForHistory.disease || ' ----'}}</p>
              <p class="m-0"><strong>Primary Doctor:</strong> {{ getDoctorName(selectedPatientForHistory.mainDoctor) }}</p>
            </div>
          
            @if (patientHistory.length === 0) {
              <p class="text-gray-500 text-lg">No medical history found for this patient.</p>
            } @else {
              <div class="overflow-x-auto pb-2">
                <table class="w-full text-left bg-white border border-gray-200 rounded-lg overflow-hidden whitespace-nowrap">
                  <thead class="bg-cyan-600 text-white">
                    <tr>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Date</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Doctor</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide">Diagnosis / Notes</th>
                      <th class="p-3 text-[0.95em] font-semibold uppercase tracking-wide text-center">Status</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    @for (h of patientHistory; track h.id) {
                      <tr class="hover:bg-gray-50 transition-colors h-[45px]">
                        <td class="px-3 py-2 text-gray-800 align-middle">{{ formatDateDisplay(h.visitTime) }}</td>
                        <td class="px-3 py-2 text-gray-700 align-middle">Dr. {{ h.doctor?.lastName }} ({{ h.doctor?.specialization }})</td>
                        <td class="px-3 py-2 text-gray-600 italic align-middle">{{ h.description || '-' }}</td>
                        <td class="px-3 py-2 text-center align-middle">
                          @if(h.status === 'COMPLETED') {
                             <span class="text-green-600 font-bold">‚úÖ Done</span>
                          } @else {
                             <span class="text-red-600 font-bold">‚ùå Missed</span>
                          }
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        }

        @if (activeTab === 'profile') {
          <div>
            <app-profile (onError)="handleErrors($event)"></app-profile>
          </div>
        }
      </div>

    </div>
  </div>
}