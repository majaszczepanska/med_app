<div class="profile-container">
  <h2>Update your profile üè•</h2>
  @if (userRole === 'PATIENT') {
    <p class="subtitle">Add your medical details below</p>

    <form #updateForm="ngForm" (ngSubmit)="update()" (input)="clearMessages()" (change)="clearMessages()">

      <label>First name<span class="required-star">*</span></label>
      <input [(ngModel)]="updateData.firstName" name="firstName" type="text" placeholder="" #fname="ngModel" 
              minlength="3" 
              pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
              required>
      @if (fname.invalid && (fname.dirty || fname.touched)) {
          <div style="color: #dc3545; font-size: 0.85em; margin-bottom: 20px; font-weight: 500;">
            @if (fname.errors?.['required']) {
              <span style="display: block;">‚ùå First name is required.</span>
            }
            @if (fname.errors?.['minlength']) {
              <span style="display: block;">‚ùå Min. 3 characters.</span>
            }
            @if (fname.errors?.['pattern']) {
              <span style="display: block;">‚ùå Must start with a capital letter & contain letters only.</span>
            }
          </div>
      }

      <label>Last name<span class="required-star">*</span></label>
      <input [(ngModel)]="updateData.lastName" name="lastName" type="text" placeholder="" #lname="ngModel"
              minlength="3" 
              pattern="^[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+(-[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª][a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]+)?$" 
              required>
      @if (lname.invalid && (lname.dirty || lname.touched)) {
          <div style="color: #dc3545; font-size: 0.85em; margin-bottom: 20px; font-weight: 500;">
            @if (lname.errors?.['required']) {
              <span style="display: block;">‚ùå Last name is required.</span>
            }
            @if (lname.errors?.['minlength']) {
              <span style="display: block;">‚ùå Min. 3 characters.</span>
            }
            @if (lname.errors?.['pattern']) {
              <span style="display: block;">‚ùå Must start with a capital letter & contain letters only.</span>
            }
          </div>
      }

      <label>Pesel<span class="required-star">*</span></label>
      <input [(ngModel)]="updateData.pesel" name="pesel" type="text" placeholder="" #pesel="ngModel" 
            pattern="^\d{2}(?:0[1-9]|1[0-2]|2[1-9]|3[0-2]|4[1-9]|5[0-2]|6[1-9]|7[0-2]|8[1-9]|9[0-2])(?:0[1-9]|[12]\d|3[01])\d{5}$"
            required>
      @if (pesel.invalid && (pesel.dirty || pesel.touched)) {
          <div style="color: #dc3545; font-size: 0.85em;  margin-bottom: 20px; font-weight: 500;">
            @if (pesel.errors?.['required']) {
              <span>‚ùå PESEL is required.</span>
            }
            @if (pesel.errors?.['pattern']) {
              <span>‚ùå Invalid PESEL format (check your data).</span>
            }
          </div>
        }


      <label>Phone number</label>
      <input [(ngModel)]="updateData.phoneNumber" name="phoneNumber" type="tel" placeholder="e.g. 123456789" pattern="^[0-9]{9}$" #phone="ngModel" required>
      @if (phone.invalid && (phone.dirty || phone.touched)) {
        <div style="color: #dc3545; font-size: 0.85em; margin-bottom: 20px; font-weight: 500;">
          <span>‚ùå Phone number must contain exactly 9 digits (no spaces or letters).</span>
        </div>
      }



      <label>Home address</label>
      <input [(ngModel)]="updateData.address" name="address" type="text" placeholder="City, Street, Apt" required>

      <label>Medical history / diseases</label>
      <input [(ngModel)]="updateData.disease" name="disease" type="text" placeholder="Any chronic diseases?" required>

      <label>Choose your Main Doctor</label>
      <select [(ngModel)]="updateData.mainDoctorId" name="mainDoctorId" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px;">
        <option [ngValue]="null">-- Select a Doctor --</option>
        @for (doc of doctorsList; track doc.id) {
          <option [ngValue]="doc.id">Dr. {{ doc.firstName }} {{ doc.lastName }} ({{ doc.specialization }})</option>
        }
      </select>  

      @if (profileSuccess) {
        <div style="background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #c3e6cb; font-weight: 500;">
          {{ profileSuccess }}
        </div>
      }
      @if (profileError) {
        <div style="background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #f5c6cb; font-weight: 500;">
          {{ profileError }}
        </div>
      }

      <button type="submit" 
        [disabled]="updateForm.invalid"
        [style.opacity]="updateForm.invalid ? '0.5' : '1'"
        [style.cursor]="updateForm.invalid ? 'not-allowed' : 'pointer'">
        Save Changes</button>
    </form>
    <hr>
  }

  @if (userRole === 'DOCTOR' || userRole === 'ADMIN') {
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #007bff;">
      <p style="margin: 0; font-size: 1.1em;"><strong>Account Details</strong></p>
      
      <div style="margin-top: 10px; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ccc;">
        <p style="margin: 0 0 5px 0;"><strong>System Role: </strong> <span style="color: #007bff; font-weight: bold;">{{ userRole }}</span></p>
        
        <p style="margin: 0 0 5px 0;"><strong>Email Address:</strong> {{ myEmail }}</p>

        @if (userRole === 'DOCTOR' && myDoctorInfo) { <hr style="margin: 10px 0; border-top: 1px solid #eee;">
          <p style="margin: 0 0 5px 0;"><strong>Full Name:</strong> Dr. {{ myDoctorInfo?.firstName }} {{ myDoctorInfo?.lastName }}</p>
          <p style="margin: 0;"><strong>Specialization:</strong> {{ myDoctorInfo?.specialization }}</p>
          
          <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #6c757d;">
            üë®‚Äç‚öïÔ∏è To update your personal details, please contact the Clinic Administrator.
          </p>
        }
      </div>

      @if (userRole === 'DOCTOR') {
        <div style="background: #ffeeba; padding: 10px; border-radius: 5px; margin-top: 15px; border: 1px solid #ffe8a1;">
          <p style="margin: 0; color: #856404; font-weight: bold;">üí° Security Tip:</p>
          <p style="margin: 0; color: #856404; font-size: 0.9em;">
            Make sure to change your temporary password provided by the Administrator to a private, secure one below.
          </p>
        </div>
      }
    </div>
  }

  <div class="password-change-section">
    <h3>Change Password</h3>
    
    <form (ngSubmit)="changePassword()">
      <div class="form-group" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Current password</label>
        <div style="position: relative; width: 100%;">
          <input [type]="showOldPass ? 'text' : 'password'" [(ngModel)]="passwordData.oldPassword" name="oldPassword" required style="width: 100%; padding: 12px 40px 12px 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; margin-bottom: 0; height: 45px;">
          <button type="button" (click)="showOldPass = !showOldPass" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; background: transparent; border: none; cursor: pointer; color: #6c757d; outline: none;">
            <mat-icon>{{ showOldPass ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
      </div>
    
      <div class="form-group" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">New password</label>
        <div style="position: relative; width: 100%;">
          <input [type]="showNewPass ? 'text' : 'password'" [(ngModel)]="passwordData.newPassword" name="newPassword" required style="width: 100%; padding: 12px 40px 12px 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; margin-bottom: 0; height: 45px;">
          <button type="button" (click)="showNewPass = !showNewPass" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; background: transparent; border: none; cursor: pointer; color: #6c757d; outline: none;">
            <mat-icon>{{ showNewPass ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
      </div>
    
      <div class="form-group" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Confirm new password</label>
        <div style="position: relative; width: 100%;">
          <input [type]="showConfPass ? 'text' : 'password'" [(ngModel)]="passwordData.confirmPassword" name="confirmPassword" required style="width: 100%; padding: 12px 40px 12px 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; margin-bottom: 0; height: 45px;">
          <button type="button" (click)="showConfPass = !showConfPass" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; background: transparent; border: none; cursor: pointer; color: #6c757d; outline: none;">
            <mat-icon>{{ showConfPass ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
      </div>
    

      @if (passSuccess) {
        <div style="background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #c3e6cb; font-weight: 500;">
          {{ passSuccess }}
        </div>
      }
      @if (passError) {
        <div style="background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #f5c6cb; font-weight: 500;">
          {{ passError }}
        </div>
      }


      <button type="submit" class="btn btn-warning">Update Password</button>
    </form>
  </div>
</div>